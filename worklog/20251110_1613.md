# 20251110_1613 - シーケンサーに高精度タイマーを実装

## 変更内容の概要

- Sequencerクラスに独立した高精度タイマー（SDL_AddTimer）を実装した
- デフォルトで15ms間隔（32分音符相当の精度）で音符進行処理を実行
- メインループ（VSync影響、約16ms）に依存しない独立した更新処理を実現
- 更新間隔はシーケンサー単位で設定可能（setUpdateInterval）

## 変更理由

メインループの更新間隔（VSync影響で約16.67ms）では、細かい音符のタイミングに揺らぎが発生する。特に効果音用途で32分音符や64分音符を使う場合、この揺らぎが顕著になる。SDL_AddTimerを使って独立した高頻度タイマーを実装することで、メインループの影響を受けずに正確なタイミングで音符を進行できるようにした。

## 変更箇所

### game_manager/sound_synthesizer.h

#### 1. Sequencerクラスのメンバー変数追加

```cpp
SDL_TimerID timer_id_;          // タイマーID
Uint32 update_interval_ms_;     // 更新間隔（ミリ秒）
```

**初期化**:
```cpp
Sequencer(SimpleSynthesizer* synthesizer, float bpm = 120.0f)
    : synthesizer_(synthesizer), bpm_(bpm), volume_(1.0f),
      current_note_index_(0), is_playing_(false), sequence_time_(0.0f),
      last_update_time_(0), loop_enabled_(false), loop_count_(-1),
      current_loop_(0), timer_id_(0), update_interval_ms_(15) {
  // デフォルト: 32分音符相当の精度（15ms間隔）
}
```

#### 2. デストラクタの追加

```cpp
~Sequencer() {
  stopTimer();
}
```
- タイマーのクリーンアップを保証

#### 3. 更新間隔の設定メソッド追加

```cpp
/**
 * @brief シーケンサーの更新間隔を設定（ミリ秒）
 * @param interval_ms 更新間隔（ミリ秒）、小さいほど精度が高い
 */
void setUpdateInterval(Uint32 interval_ms);

/**
 * @brief シーケンサーの更新間隔を取得
 * @return 更新間隔（ミリ秒）
 */
Uint32 getUpdateInterval() const;
```

#### 4. play()とstop()でタイマーを制御

```cpp
void play() {
  // ... 既存の処理 ...

  // 高精度タイマーを開始
  startTimer();
}

void stop() {
  is_playing_ = false;
  synthesizer_->noteOff();
  stopTimer();
}
```

#### 5. update()メソッドを軽量化

```cpp
/**
 * @brief 更新（メインループから毎フレーム呼び出す）
 *
 * 注: 実際の音符進行処理は内部タイマーで行われるため、
 * このメソッドは状態チェック程度の軽量処理のみ行う
 */
void update() {
  // タイマーベースの更新に移行したため、このメソッドは空にする
  // 必要に応じて状態確認などの軽量処理のみ行う
}
```

#### 6. プライベートメソッドの追加

**タイマーコールバック（SDL3対応）**:
```cpp
static Uint32 SDLCALL timerCallback(void* userdata, SDL_TimerID timerID, Uint32 interval) {
  Sequencer* sequencer = static_cast<Sequencer*>(userdata);
  if (sequencer) {
    sequencer->internalUpdate();
  }
  return interval;  // 同じ間隔で継続
}
```

**タイマー制御メソッド**:
```cpp
void startTimer() {
  if (timer_id_ != 0) {
    stopTimer();  // 既存のタイマーを停止
  }
  timer_id_ = SDL_AddTimer(update_interval_ms_, timerCallback, this);
  if (timer_id_ == 0) {
    SDL_LogError(SDL_LOG_CATEGORY_AUDIO, "Failed to create timer: %s", SDL_GetError());
  }
}

void stopTimer() {
  if (timer_id_ != 0) {
    SDL_RemoveTimer(timer_id_);
    timer_id_ = 0;
  }
}
```

**内部更新処理**:
```cpp
void internalUpdate() {
  if (!is_playing_ || sequence_.empty()) return;

  // 経過時間を計算
  Uint64 current_time = SDL_GetTicks();
  float delta_time = (current_time - last_update_time_) / 1000.0f;
  last_update_time_ = current_time;

  sequence_time_ += delta_time;

  // 現在の音符が終了したか確認
  if (current_note_index_ < sequence_.size()) {
    const NoteData& current_note = sequence_[current_note_index_];
    if (sequence_time_ >= current_note.duration) {
      // 次の音符へ
      sequence_time_ -= current_note.duration;
      current_note_index_++;

      if (current_note_index_ < sequence_.size()) {
        playCurrentNote();
      } else {
        // シーケンス終了
        handleSequenceEnd();
      }
    }
  }
}
```

## タイミング精度の改善

### 従来の実装（メインループベース）

```
メインループ（VSync影響）
↓ 約16.67ms間隔
Sequencer::update()
↓
音符進行処理
```

- **問題点**:
  - VSync待ちで約16.67ms（60Hz）の間隔
  - 32分音符（120BPMで約62.5ms）でも最大16ms程度の揺らぎ
  - 64分音符（約31ms）では半分程度のずれが発生

### 新しい実装（独立タイマーベース）

```
SDL_AddTimer（独立スレッド）
↓ 15ms間隔（設定可能）
timerCallback()
↓
Sequencer::internalUpdate()
↓
音符進行処理
```

- **改善点**:
  - メインループに依存しない独立したタイミング
  - デフォルト15ms間隔で32分音符以下も正確に処理
  - シーケンサー単位で精度を調整可能

## 更新間隔の推奨値

| 用途 | 推奨間隔 | 対応する最小音符（120BPM） |
|------|---------|------------------------|
| BGM（ゆったり） | 30ms | 16分音符（125ms） |
| 通常の音楽 | 15ms（デフォルト） | 32分音符（62.5ms） |
| 効果音（細かい） | 10ms | 64分音符（31.25ms） |
| 超高精度 | 5ms | 128分音符（15.6ms） |

**注意**: 間隔を小さくしすぎると、CPU負荷が増加する可能性があります。

## 使用例

```cpp
// デフォルト（15ms間隔 = 32分音符精度）
sequencer->play();

// 高精度（10ms間隔 = 64分音符精度）
sequencer->setUpdateInterval(10);
sequencer->play();

// 低負荷（30ms間隔 = 16分音符精度）
sequencer->setUpdateInterval(30);
sequencer->play();
```

## パフォーマンスへの影響

- **CPU負荷**: タイマーコールバックは軽量な処理のみ行うため、負荷は最小限
- **メモリ**: 追加のメモリ使用量は微少（タイマーID 1つ分）
- **スレッドセーフ**: SDL_AddTimerは別スレッドから呼ばれるが、SimpleSynthesizer自体がスレッドセーフに設計されているため問題なし

## SDL3のタイマーコールバック仕様

SDL3ではタイマーコールバックのシグネチャがSDL2から変更されています：

**SDL2**:
```c
Uint32 callback(Uint32 interval, void* param);
```

**SDL3**:
```c
Uint32 callback(void* userdata, SDL_TimerID timerID, Uint32 interval);
```

引数の順序と内容が変更されているため、SDL3では第1引数にuserdata、第2引数にtimerIDを受け取ります。

## テスト方法

1. ビルドして実行: `cmake --build build && ./build/main`
2. **Enterキー**: BGM（無限ループ）を再生
3. 細かい音符のタイミングが正確に再生されることを確認

## 今後の拡張可能性

- シーケンサーごとに異なる精度を設定（BGMは低精度、SEは高精度など）
- 動的な精度調整（負荷に応じて自動調整）
- タイミング統計情報の収集（ジッター測定など）
