# 20251110_2030 - サウンドライブラリの分離とリファクタリング (Phase 1)

## 変更内容の概要

- game_manager/sound_synthesizer.hから独立したsound/ライブラリを作成
- namespaceをMyGameからMySoundに変更
- コアクラス（Oscillator, Envelope, SimpleSynthesizer）をヘッダと実装に分離
- 定数、型定義、ユーティリティを個別ファイルに分割
- CMakeLists.txtにsoundライブラリを追加し、ビルドシステムに統合

## 変更理由

サウンド関連のコード量が1300行を超え、1つのヘッダファイルに全てが詰め込まれていた。今後エフェクトや高機能シンセサイザーを追加する前に、コードを整理して見通しを良くする必要があった。また、SDL3のみに依存する独立したライブラリとして切り出すことで、将来的に他のプロジェクトでも再利用可能にした。

## Phase 1の方針

段階的アプローチを採用：
- **Phase 1** (今回): 基本的なシンセサイザー機能を分離
- **Phase 2** (次回): Sequencer, MultiTrackSequencer, BGMManager を分離
- **Phase 3** (次回): MMLParser を分離し、既存コードを完全移行

各段階でビルドテストを行い、安全に進める。

## ディレクトリ構造

```
sound/
├── sound_constants.h           # 定数定義（サンプリングレート等）
├── sound.h                     # 統合ヘッダ（このファイルをインクルードすればOK）
├── types/
│   ├── wave_type.h            # WaveType enum
│   └── note.h                 # Note enum, NoteData struct
├── core/
│   ├── oscillator.h/.cpp      # Oscillator（波形生成）
│   ├── envelope.h/.cpp        # Envelope（ADSR）
│   └── synthesizer.h/.cpp     # SimpleSynthesizer
└── utilities/
    ├── music_utilities.h      # MusicUtil（constexpr音楽計算）
    └── fixed_note_sequence.h  # FixedNoteSequence（constexpr配列）
```

## 作成したファイル

### 1. sound/sound_constants.h

**概要**: ライブラリ全体で使用する定数を定義。

```cpp
namespace MySound {
  constexpr int DEFAULT_SAMPLE_RATE = 44100;
  constexpr Uint64 DEFAULT_SEQUENCER_UPDATE_INTERVAL_NS = 15000000;  // 15ms
  constexpr float DEFAULT_BPM = 120.0f;
  constexpr float DEFAULT_ATTACK_TIME = 0.01f;
  constexpr Uint32 DEFAULT_NOISE_SEED = 0x12345678;
  constexpr Uint32 LCG_MULTIPLIER = 1664525u;
  constexpr Uint32 LCG_INCREMENT = 1013904223u;
  // ... その他の定数
}
```

### 2. sound/types/wave_type.h

**概要**: 波形の種類を定義。

```cpp
namespace MySound {
  enum class WaveType {
    Sine,      // サイン波
    Square,    // 矩形波
    Sawtooth,  // ノコギリ波
    Noise      // ホワイトノイズ（LCG方式）
  };
}
```

### 3. sound/types/note.h

**概要**: 音階とノートデータを定義。

```cpp
namespace MySound {
  enum class Note {
    C = 0, Cs = 1, D = 2, Ds = 3, E = 4, F = 5,
    Fs = 6, G = 7, Gs = 8, A = 9, As = 10, B = 11
  };

  struct NoteData {
    Note note;
    int octave;
    float duration;
    bool is_rest;
    WaveType wave_type;
    float volume;

    constexpr NoteData(/* ... */);
    constexpr float getFrequency() const;
  private:
    static constexpr float constexpr_pow(float base, float exp);
  };
}
```

**特徴**: constexpr対応のべき乗関数を使って周波数計算を実現。

### 4. sound/utilities/music_utilities.h

**概要**: 音楽関連の計算ユーティリティ（constexpr対応）。

```cpp
namespace MySound {
  class MusicUtil {
   public:
    static constexpr float noteToFrequency(Note note, int octave);
    static constexpr float noteDuration(float bpm, int note_division, bool dotted = false);
   private:
    static constexpr float constexpr_pow(float base, float exp);
  };
}
```

### 5. sound/utilities/fixed_note_sequence.h

**概要**: 固定サイズの音符シーケンス（constexpr対応）。

```cpp
namespace MySound {
  class FixedNoteSequence {
   public:
    constexpr FixedNoteSequence();
    constexpr void push_back(const NoteData& note);
    constexpr size_t size() const;
    constexpr const NoteData& operator[](size_t index) const;
    // ... その他のメソッド
   private:
    size_t size_;
    std::array<NoteData, MAX_NOTE_SEQUENCE_SIZE> data_;
  };
}
```

### 6. sound/core/oscillator.h / .cpp

**概要**: 波形生成クラス。

**ヘッダ**:
```cpp
namespace MySound {
  class Oscillator {
   public:
    explicit Oscillator(WaveType wave_type = WaveType::Sine,
                        float frequency = DEFAULT_FREQUENCY);
    void setWaveType(WaveType wave_type);
    void setFrequency(float frequency);
    void setNoiseSeed(Uint32 seed);
    float generate(float phase) const;
   private:
    float generateNoise() const;
    WaveType wave_type_;
    float frequency_;
    mutable Uint32 noise_state_;
  };
}
```

**実装のポイント**:
- LCGによるホワイトノイズ生成
- phaseベースの波形生成
- mutable noise_state_でconstメソッドから状態変更

### 7. sound/core/envelope.h / .cpp

**概要**: ADSRエンベロープ。

**ヘッダ**:
```cpp
namespace MySound {
  class Envelope {
   public:
    enum class State {
      Idle, Attack, Decay, Sustain, Release
    };

    Envelope();
    void setADSR(float attack_time, float decay_time, float sustain_level, float release_time);
    void noteOn();
    void noteOff();
    float process(int sample_rate);
    State getState() const;
   private:
    float attack_time_, decay_time_, sustain_level_, release_time_;
    State state_;
    float current_level_, release_level_;
  };
}
```

**実装のポイント**:
- 内部で状態管理（noteOn/noteOffで遷移）
- サンプル単位でエンベロープ値を計算
- process()は1サンプルごとに呼び出し

### 8. sound/core/synthesizer.h / .cpp

**概要**: シンプルなシンセサイザー。

**ヘッダ**:
```cpp
namespace MySound {
  class SimpleSynthesizer {
   public:
    explicit SimpleSynthesizer(int sample_rate = DEFAULT_SAMPLE_RATE);
    ~SimpleSynthesizer();

    Oscillator& getOscillator();
    Envelope& getEnvelope();
    void setVolume(float volume);
    float getVolume() const;
    void noteOn(float frequency, float duration = 0.0f, float volume = 1.0f);
    void noteOff();
    void update();
    int getSampleRate() const;

   private:
    static void SDLCALL audioCallback(void* userdata, SDL_AudioStream* stream,
                                      int additional_amount, int total_amount);
    void generateSamples(float* samples, int num_samples);
    float getCurrentTime() const;

    std::unique_ptr<Oscillator> oscillator_;
    std::unique_ptr<Envelope> envelope_;
    SDL_AudioStream* stream_;
    // ... その他のメンバー変数
  };
}
```

**実装のポイント**:
- SDL_OpenAudioDeviceStreamでコールバック方式
- バックグラウンドスレッドでサンプル生成
- エンベロープとオシレーターを組み合わせて波形生成

### 9. sound/sound.h（統合ヘッダ）

**概要**: 全てのヘッダをまとめたファイル。

```cpp
#pragma once

// 定数
#include "sound_constants.h"

// 基本型
#include "types/wave_type.h"
#include "types/note.h"

// ユーティリティ
#include "utilities/music_utilities.h"
#include "utilities/fixed_note_sequence.h"

// コアクラス
#include "core/oscillator.h"
#include "core/envelope.h"
#include "core/synthesizer.h"
```

**使用例**:
```cpp
#include "sound/sound.h"

using namespace MySound;

auto synth = std::make_unique<SimpleSynthesizer>(44100);
synth->getEnvelope().setADSR(0.01f, 0.1f, 0.7f, 0.2f);
synth->noteOn(440.0f, 1.0f);  // A4を1秒間
```

### 10. CMakeLists.txtの変更

```cmake
# sound library (Phase 1: core classes)
set(SOUND_SOURCES
    sound/core/oscillator.cpp
    sound/core/envelope.cpp
    sound/core/synthesizer.cpp
)
add_library(sound ${SOUND_SOURCES})
target_link_libraries(sound PRIVATE SDL3::SDL3)
target_include_directories(sound PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

# game_manager
add_library(game_manager game_manager/draw_helper.cc)
target_link_libraries(game_manager PRIVATE SDL3::SDL3 sound)

# main
add_executable(main game.cc)
target_link_libraries(main PRIVATE SDL3::SDL3 sound game_manager games)
```

## namespaceの変更

- **変更前**: `namespace MyGame`
- **変更後**: `namespace MySound`

**理由**: サウンドライブラリとして独立させるため、より明確な名前空間を使用。

## constexpr対応について

以下のクラス/関数はconstexpr対応：
- `MusicUtil::noteToFrequency()`
- `MusicUtil::noteDuration()`
- `NoteData::getFrequency()`
- `FixedNoteSequence` 全メソッド

これにより、MMLパーサーなどでコンパイル時評価が可能。

## ビルド結果

```
[ 94%] Building CXX object CMakeFiles/sound.dir/sound/core/oscillator.cpp.o
[ 95%] Building CXX object CMakeFiles/sound.dir/sound/core/envelope.cpp.o
[ 95%] Building CXX object CMakeFiles/sound.dir/sound/core/synthesizer.cpp.o
[ 96%] Linking CXX static library libsound.a
[ 96%] Built target sound
...
[100%] Built target main
```

**成功！** 全てのファイルが正常にコンパイルされ、`libsound.a`が生成された。

## Phase 1で未実装の部分

以下は既存のsound_synthesizer.hにあるが、Phase 1では分離していない：
- Sequencer
- MultiTrackSequencer
- BGMManager
- MMLParser

これらは**Phase 2以降**で分離予定。

## Phase 2の計画

次の段階で以下を実装：
1. `sound/mml/mml_parser.h`（constexpr対応、ヘッダのみ）
2. `sound/sequencer/sequencer.h/.cpp`
3. `sound/sequencer/multi_track_sequencer.h/.cpp`
4. `sound/sequencer/bgm_manager.h/.cpp`
5. `game_manager/sound_synthesizer.h`の参照を`sound/sound.h`に置き換え
6. 既存コード（test_impl_3など）の動作確認

## メリット

1. **可読性向上**: 各クラスが独立したファイルに分離され、理解しやすい
2. **再利用性**: SDL3のみに依存する独立ライブラリとして他プロジェクトでも使用可能
3. **ビルド時間短縮**: 変更箇所のみ再コンパイル可能
4. **namespace分離**: MySoundとして独立した名前空間
5. **拡張性**: 今後のエフェクト追加やシンセサイザー機能拡張が容易

## 既存コードへの影響

Phase 1では既存コード（game_manager/sound_synthesizer.h）はそのまま残しているため、**既存の機能は全て動作します**。Phase 2以降で段階的に移行します。

## 今後の作業

1. Phase 2: Sequencer関連の分離
2. Phase 3: 既存コードの完全移行
3. エフェクト機能の追加（Reverb, Delay, Filterなど）
4. 高機能シンセサイザー（FM, サンプラーなど）

## 技術的な詳細

### ヘッダと実装の分離基準

- **ヘッダのみ**: constexpr対応が必要なクラス（MusicUtil, FixedNoteSequence）
- **ヘッダ+実装**: 実行時処理が中心のクラス（Oscillator, Envelope, SimpleSynthesizer）

### mutableの使用

Oscillator::noise_state_をmutableにすることで、generate()がconstメソッドでありながらLCGの状態を更新可能。これは論理的constness（外部から見た振る舞い）を維持しながら、内部実装の詳細を変更する一般的なパターン。

### 型の前方宣言

相互依存を避けるため、各ヘッダは必要最小限のインクルードのみ行う。統合ヘッダ（sound.h）が全体の依存関係を解決。

## まとめ

Phase 1として、サウンドライブラリの基盤を整備しました。コアクラス（Oscillator, Envelope, SimpleSynthesizer）をMySound名前空間の下に独立したライブラリとして分離し、ビルドシステムに統合しました。既存の機能は保持したまま、今後の拡張に向けた土台が完成しました。
