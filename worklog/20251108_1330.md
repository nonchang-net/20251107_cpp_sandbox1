# 作業レポート - 2025/11/08 13:30

## 変更内容の概要

- ゲームループ中に表示順序を制御可能なエンティティ管理システムを実装しました
- Entity基底クラスとEntityManagerコンテナクラスを作成しました（game_manager/entity_manager.h）
- レイヤー番号による表示順制御、状態フラグによる表示/非表示管理、効率的な追加・削除・列挙をサポートしています
- デモ実装（TestImpl3）を作成し、動作確認しました

## 変更理由

- **レイヤー管理の必要性**: 背景、前景、UIなどの表示順序を明確に管理するため、レイヤー番号による階層化を実装しました。std::mapを使用することで、自動的にレイヤー順にソートされ、O(log n)で効率的にアクセスできます
- **状態フラグの柔軟性**: 「表示中」「一時非表示」「点滅状態」など、ゲーム実装によって異なる状態を管理できるよう、std::array<int, 8>で汎用的な状態フラグ配列を提供しました
- **効率的な追加・削除**: ゲームループ中に頻繁に行われるエンティティの追加・削除を最適化するため、削除マークによる遅延削除を採用しました。これにより、削除はO(1)でマーク、cleanup()でまとめてO(n)で実行されます
- **列挙の高速化**: std::mapは自動的にキー（レイヤー番号）順にソートされるため、レイヤー順の列挙がO(n)で高速に行えます

## 技術的な実装詳細

### Entity基底クラス
- 仮想関数 `update()` と `render()` で更新・描画をサポート
- レイヤー番号と8つの状態フラグを保持
- `destroy()` で削除マーク（アクティブフラグをfalseに設定）

### EntityManager
- `std::map<int, std::vector<std::unique_ptr<Entity>>>` でレイヤーごとにエンティティを管理
- `addEntity()`: O(1)で追加（vectorのpush_back）
- `cleanup()`: O(n)で非アクティブエンティティを削除
- `renderAll()`: O(n)でレイヤー順に描画（std::mapの自動ソート利用）

### TestImpl3デモ実装
- RectEntity: 移動する四角形エンティティ
- TextEntity: テキスト表示エンティティ
- レイヤー0: 背景、レイヤー1: 前景、レイヤー2: 点滅、レイヤー10: UI
- 2秒ごとにランダムなエンティティを追加（最大50個）
- キー操作: R（リセット）、C（クリーンアップ）、Q（終了）

## パフォーマンス特性

| 操作 | 計算量 | 備考 |
|------|--------|------|
| エンティティ追加 | O(1) | vectorのpush_back |
| エンティティ削除マーク | O(1) | フラグ設定のみ |
| クリーンアップ | O(n) | 非アクティブを一括削除 |
| レイヤー順列挙 | O(n) | mapの自動ソート利用 |

これにより、ゲームループ中の頻繁な追加・削除と毎フレームの描画処理を効率的に実行できます。
