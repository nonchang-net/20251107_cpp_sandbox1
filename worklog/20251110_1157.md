# 20251110_1157 - MMLパーサーのconstexpr対応

## 変更内容の概要

- MMLパーサー（`MMLParser::parse()`）と関連する関数を`constexpr`対応にした
- パース処理がコンパイル時に評価可能になり、最適化レベルによってはコンパイル時に計算される
- `inline const`を使ってMMLプリセットを定義し、使用箇所を更新した

## 変更理由

MMLのパース処理は実行時に行う必要がなく、コンパイル時に評価できれば実行時のオーバーヘッドを削減できる。C++20の`constexpr`機能を活用して、MMLパーサーをコンパイル時評価可能にした。ただし、C++20では`std::vector`を`constexpr`変数として保存できないため、`inline const`を使用してコンパイラの最適化に委ねる形にした。

## 変更箇所

### game_manager/sound_synthesizer.h

1. **NoteDataのコンストラクタを`constexpr`化**:
   ```cpp
   constexpr NoteData(Note n, int oct, float dur, bool rest = false, WaveType wave = WaveType::Sine)
   ```

2. **MusicUtilのメソッドを`constexpr`化**:
   - `beatDuration()`: BPMから拍の長さを計算
   - `noteDuration()`: BPMと音符分数から音符の長さを計算

3. **MMLParser::parse()を`constexpr`化**:
   - `std::tolower`、`std::isspace`、`std::isdigit`の代わりに自前の`constexpr`版を実装
   - `constexpr_tolower()`: 大文字を小文字に変換
   - `constexpr_isspace()`: 空白文字判定
   - `constexpr_isdigit()`: 数字判定
   - `charToNote()`、`parseNumber()`も`constexpr`化

4. **ユーザー定義リテラル`operator""_mml`を`constexpr`化**:
   ```cpp
   constexpr std::vector<NoteData> operator""_mml(const char* str, size_t len)
   ```

### game/test_impl_3.h

1. **MMLプリセットを`inline const`で定義**:
   ```cpp
   namespace MMLPresets {
     inline const auto frog_song = "t120 o4 l4 @0 cdefedec"_mml;
     inline const auto oscillator_demo = "t140 o4 l8 @1 cdefgab>c r4 @2 <bagfedc"_mml;
   }
   ```

2. **キーハンドラーでプリセットを使用**:
   - Enterキー: `MMLPresets::frog_song`を使用
   - Mキー: `MMLPresets::oscillator_demo`を使用

## C++20のconstexpr制限について

C++20では`std::vector`を`constexpr`関数内でローカル変数として使用できるが、`constexpr`変数として保存することはできない（ヒープ割り当てが必要なため）。そのため、以下のようにした：

- **できないこと**: `constexpr auto notes = "..."_mml;` （コンパイルエラー）
- **できること**: `inline const auto notes = "..."_mml;` （最適化によってコンパイル時評価される可能性がある）

パーサー自体は`constexpr`関数なので、コンパイラの最適化レベル（`-O2`以上）によってはコンパイル時に評価され、実行時のパース処理が削減される。

## 使用例

```cpp
// グローバルスコープやクラススコープで定義（inline constが必要）
namespace MMLPresets {
  inline const auto melody = "t120 o4 l4 cdefgab"_mml;
}

// 関数内で使用（毎回パースされるが、constexpr関数なので最適化される可能性がある）
void play() {
  auto notes = "t120 o4 cdefgab"_mml;  // コンパイラが最適化する可能性
  sequencer_->setSequence(std::move(notes));
  sequencer_->play();
}

// プリセットを使用（推奨）
void play_preset() {
  sequencer_->setSequence(MMLPresets::melody);
  sequencer_->play();
}
```

## 実装上のポイント

- 標準ライブラリの文字操作関数（`std::tolower`など）は`constexpr`ではないため、自前で実装
- `SDL_powf`などのSDL関数は`constexpr`ではないが、パース時には使わないので問題ない
- `MusicUtil::noteToFrequency()`は`SDL_powf`を使うため`constexpr`にできないが、パース時ではなく再生時に使うので問題ない

## テスト方法

1. ビルドして実行: `cmake --build build && ./build/main`
2. **Enterキー**: カエルの歌が再生される（MMLプリセット使用）
3. **Mキー**: オシレーター変更デモが再生される（MMLプリセット使用）
