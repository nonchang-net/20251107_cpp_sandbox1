# 20251110_1601 - シーケンサーにループ再生機能を実装

## 変更内容の概要

- Sequencerクラスにループ再生機能を追加した
- 無限ループ（loop_count = -1）と回数指定ループ（loop_count >= 0）の両方をサポート
- test_impl_3.hでループ再生のテストケースを追加（Lキー: 無限ループ、Kキー: 3回ループ）
- Enterキーの多重演奏BGMに無限ループを設定してBGM風の動作を実現

## 変更理由

BGM用途では、シーケンスを繰り返し再生する必要がある。毎回手動で再生し直すのではなく、自動的にループ再生できる機能を実装することで、BGMとしての実用性が高まる。

## 変更箇所

### game_manager/sound_synthesizer.h

#### 1. Sequencerクラスのメンバー変数追加

```cpp
bool loop_enabled_;      // ループ有効フラグ
int loop_count_;         // ループ回数（-1=無限、0以上=指定回数）
int current_loop_;       // 現在のループ回数
```

**初期化**:
```cpp
Sequencer(SimpleSynthesizer* synthesizer, float bpm = 120.0f)
    : synthesizer_(synthesizer), bpm_(bpm), volume_(1.0f),
      current_note_index_(0), is_playing_(false), sequence_time_(0.0f),
      last_update_time_(0), loop_enabled_(false), loop_count_(-1),
      current_loop_(0) {}
```

#### 2. ループ設定のgetter/setter追加

```cpp
/**
 * @brief ループ再生を設定
 * @param enabled ループを有効にするか
 * @param count ループ回数（-1で無限ループ、0以上で指定回数、0で1回のみ再生）
 */
void setLoop(bool enabled, int count = -1);

/**
 * @brief ループが有効かどうか
 * @return ループが有効ならtrue
 */
bool isLoopEnabled() const;

/**
 * @brief 現在のループ回数を取得
 * @return 現在のループ回数（0始まり）
 */
int getCurrentLoop() const;
```

#### 3. play()メソッドでループカウンタをリセット

```cpp
void play() {
  if (sequence_.empty()) return;

  current_note_index_ = 0;
  sequence_time_ = 0.0f;
  current_loop_ = 0;  // NEW: ループカウンタをリセット
  is_playing_ = true;
  last_update_time_ = SDL_GetTicks();

  playCurrentNote();
}
```

#### 4. update()メソッドでシーケンス終了時の処理を変更

```cpp
if (current_note_index_ < sequence_.size()) {
  playCurrentNote();
} else {
  // シーケンス終了
  handleSequenceEnd();  // NEW: ループ処理を追加
}
```

#### 5. handleSequenceEnd()メソッドを新規追加

```cpp
/**
 * @brief シーケンス終了時の処理
 */
void handleSequenceEnd() {
  if (!loop_enabled_) {
    // ループが無効の場合は停止
    is_playing_ = false;
    return;
  }

  // ループ回数をチェック
  if (loop_count_ >= 0) {
    // 回数指定ループの場合
    current_loop_++;
    if (current_loop_ > loop_count_) {
      // 指定回数に達したので停止
      is_playing_ = false;
      return;
    }
  }
  // loop_count_ == -1の場合は無限ループ

  // シーケンスを最初から再生
  current_note_index_ = 0;
  sequence_time_ = 0.0f;
  playCurrentNote();
}
```

### game/test_impl_3.h

#### 1. Enterキーに無限ループを設定（BGM風）

```cpp
case SDL_SCANCODE_RETURN: {
  // Enterキー: BGM風多重演奏（無限ループ）
  sequencer1_->clear();
  sequencer2_->clear();

  // BGM用に無限ループを設定
  sequencer1_->setLoop(true, -1);  // 無限ループ
  sequencer2_->setLoop(true, -1);  // 無限ループ

  sequencer1_->setSequence(...);
  sequencer2_->setSequence(...);
  sequencer1_->play();
  sequencer2_->play();
  break;
}
```

#### 2. Lキーで無限ループテスト

```cpp
case SDL_SCANCODE_L: {
  // Lキー: 無限ループ再生デモ
  sequencer_->clear();
  sequencer_->setLoop(true, -1);  // 無限ループ
  sequencer_->setSequence(MMLPresets::frog_song);
  sequencer_->play();
  break;
}
```

#### 3. Kキーで3回ループテスト

```cpp
case SDL_SCANCODE_K: {
  // Kキー: 3回ループ再生デモ
  sequencer_->clear();
  sequencer_->setLoop(true, 3);  // 3回ループ（合計4回再生）
  sequencer_->setSequence(MMLPresets::frog_song);
  sequencer_->play();
  break;
}
```

#### 4. その他のキーでループを明示的に無効化

```cpp
// Mキー、Vキー
sequencer_->setLoop(false);  // ループ無効
```

#### 5. ヘルプテキストの更新

```cpp
SDL_RenderDebugText(renderer_, 10, 30, "Space: Test, 1-8: Scale, O: Wave");
SDL_RenderDebugText(renderer_, 10, 40, "Enter: Melody, M: Osc, V: Vol, L: Loop, K: 3xLoop");
```

## ループ回数の仕様

| loop_count | 動作 | 実際の再生回数 |
|-----------|------|--------------|
| -1 | 無限ループ | ∞ |
| 0 | 1回のみ再生 | 1回 |
| 1 | 1回ループ（計2回再生） | 2回 |
| 2 | 2回ループ（計3回再生） | 3回 |
| 3 | 3回ループ（計4回再生） | 4回 |
| n | n回ループ（計n+1回再生） | n+1回 |

**注意**: `loop_count`は「何回ループするか」を表し、最初の1回を除いた追加再生回数を意味する。
- 例: `loop_count = 3`の場合、最初の1回 + ループ3回 = 合計4回再生

## 使用例

```cpp
// 1. 無限ループ（BGM用）
sequencer->setLoop(true, -1);
sequencer->setSequence("t120 o4 l4 cdefgab"_mml);
sequencer->play();  // 永遠に繰り返す

// 2. 3回ループ（合計4回再生）
sequencer->setLoop(true, 3);
sequencer->setSequence("t120 o4 l4 cdefgab"_mml);
sequencer->play();  // 4回再生して停止

// 3. ループ無効（1回のみ再生）
sequencer->setLoop(false);
sequencer->setSequence("t120 o4 l4 cdefgab"_mml);
sequencer->play();  // 1回再生して停止

// 4. 現在のループ回数を取得
int current = sequencer->getCurrentLoop();  // 0, 1, 2, 3...
```

## テスト方法

1. ビルドして実行: `cmake --build build && ./build/main`
2. **Enterキー**: BGM風多重演奏（無限ループ）
3. **Lキー**: カエルの歌を無限ループ再生
4. **Kキー**: カエルの歌を3回ループ（合計4回）再生
5. **0キー**: シーケンス停止

## 技術的な詳細

### ループの実装方法

1. `handleSequenceEnd()`がシーケンス終了時に呼ばれる
2. `loop_enabled_`がtrueなら、`loop_count_`をチェック
3. `loop_count_ == -1`なら無限ループ（`current_loop_`を無視）
4. `loop_count_ >= 0`なら、`current_loop_`をインクリメントして比較
5. ループ継続の場合、`current_note_index_`と`sequence_time_`をリセットして最初から再生

### シームレスなループ

現在の実装では、シーケンスの最後の音符が終了した直後に次のループが開始される。
音符間のギャップなくシームレスにループするため、BGMとして自然な動作になる。

## BGM使用時の注意点

- 無限ループを設定した場合、`stop()`を呼ぶまで永遠に再生され続ける
- 複数のシーケンサーで無限ループを設定すると、全て停止するまで再生が続く
- 0キーで全てのシーケンスを停止できる
