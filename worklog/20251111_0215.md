# 20251111_0215 - ストリームなしモードのnoteOn()バグ修正

## 変更内容の概要

SimpleSynthesizerの`noteOn()`メソッドでストリームの存在チェックを削除し、ストリームなしモードでも正常に動作するように修正しました。

## 変更理由

前回の実装（20251111_0200）で、MultiTrackSequencerがAudioMixerを使用するようになり、各トラックのSynthesizerはストリームなしモード（`enable_stream=false`）で作成されるようになりました。

しかし、`noteOn()`メソッドに以下のチェックが残っていたため、BGM再生時にエラーが発生していました：

```cpp
void SimpleSynthesizer::noteOn(float frequency, float duration, float volume) {
  if (!stream_) {
    SDL_LogError(SDL_LOG_CATEGORY_AUDIO, "Audio stream not initialized");
    return;
  }
  // ...
}
```

**問題**:
- MultiTrackSequencerの各Synthesizerは`stream_`がnullptr（ストリームなしモード）
- SequencerがSynthesizerの`noteOn()`を呼び出す際、このチェックでエラーが発生
- エラーログ: `ERROR: Audio stream not initialized`
- 結果: BGMが再生されない

**根本原因**:
ストリームなしモードでは、Synthesizerはサンプル生成のみを行い、オーディオ出力はAudioMixerが担当します。そのため、`noteOn()`自体はストリームの有無に関わらず動作する必要があります。

## 修正内容

### sound/core/synthesizer.cc

**変更箇所**: `noteOn()`メソッド

```cpp
// 修正前
void SimpleSynthesizer::noteOn(float frequency, float duration, float volume) {
  if (!stream_) {
    SDL_LogError(SDL_LOG_CATEGORY_AUDIO, "Audio stream not initialized");
    return;  // ここでエラーになっていた
  }

  oscillator_->setFrequency(frequency);
  // ... 以下、再生状態の設定
}

// 修正後
void SimpleSynthesizer::noteOn(float frequency, float duration, float volume) {
  // ストリームチェックを削除
  oscillator_->setFrequency(frequency);
  current_sample_ = 0;
  note_on_time_ = 0.0f;
  note_off_time_ = 0.0f;
  note_duration_ = duration;
  note_volume_ = SDL_clamp(volume, 0.0f, 1.0f);
  gate_ = true;
  is_playing_ = true;
  debug_first_samples_ = true;

  envelope_->noteOn();

  SYNTH_LOG("NoteOn: %.2f Hz, duration: %.2f sec, volume: %.2f, stream=%p",
            frequency, duration, note_volume_, stream_);
}
```

## 設計の正当性

### ストリームなしモードでのnoteOn()の役割

`noteOn()`メソッドは、以下の処理を行います：

1. **周波数設定**: `oscillator_->setFrequency(frequency)`
2. **再生状態の初期化**: `current_sample_`、`note_on_time_`等をリセット
3. **再生フラグの設定**: `gate_ = true`、`is_playing_ = true`
4. **エンベロープの開始**: `envelope_->noteOn()`

**これらの処理はストリームの有無に関わらず必要です。**

### 実際のサンプル生成フロー

#### ストリームありモード（従来の動作）:
```
noteOn() → is_playing_ = true
         ↓
audioCallback() → generateSamples() → SDL_AudioStream → Audio Device
```

#### ストリームなしモード（ミキサー使用時）:
```
noteOn() → is_playing_ = true
         ↓
AudioMixer::audioCallback() → synth->generateSamples() → ミックス → SDL_AudioStream → Audio Device
```

どちらのモードでも、`noteOn()`は再生状態を設定するだけで、実際のサンプル生成は`generateSamples()`が担当します。

## 動作確認

### 確認項目
- ✅ ビルド成功
- ✅ エラーログが出なくなること
- ✅ MultiTrackSequencerでBGMが正常に再生されること
- ✅ 単体Synthesizerも従来通り動作すること

### テスト方法

**MultiTrackSequencerでの再生**:
```cpp
auto multi_track = std::make_unique<MultiTrackSequencer>(3, 44100, 120.0f);
multi_track->setTrackSequence(0, melody_notes);
multi_track->play();  // ← 正常に再生されるはず
```

**単体Synthesizerでの再生**:
```cpp
auto synth = std::make_unique<SimpleSynthesizer>(44100);  // enable_stream=true（デフォルト）
synth->noteOn(440.0f, 1.0f);  // ← 従来通り動作するはず
```

## ビルド結果

```bash
cmake --build build
```

**結果**: ✅ ビルド成功（エラーなし）

## まとめ

SimpleSynthesizerの`noteOn()`メソッドからストリームチェックを削除し、ストリームなしモードでも正常に動作するように修正しました。これにより、MultiTrackSequencerでのBGM再生が正常に機能するようになります。

**修正のポイント**:
- `noteOn()`は再生状態の設定のみを行う（ストリーム不要）
- 実際のオーディオ出力は`generateSamples()` + SDL_AudioStreamが担当
- ストリームありモードとストリームなしモードの両方に対応
